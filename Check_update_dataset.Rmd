---
title: "Check dataset udpate"
author: "Matthieu Wilhelm"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
```

Here is my mail  (4.8.2024) to Sébastien.

```
Cher Sébastien,
 
Ci-jointes les 3 tables qui seront en annexes du travail. La table 3 contient notamment des informations qui sont similaires à celles qui sont contenues dans le fichier qui a servi de bases à mes propres analyses (fichier que tu pourras retrouver ici). Je considère qu’il t’incombe de vérifier que les informations de la table 3 sont identiques à celles que tu m’avais fournies en son temps et je t’invite à faire cette vérification. Sans nouvelles de ta part d’ici la fin du mois de juillet, je considérerai que c’est tout bon et je mettrai ces trois tables sur la page git.
 
Je suis sincèrement très heureux pour toi de voir se concrétiser l’important travail que tu as mené.

Je te souhaite une belle continuation et t’adresse mes salutations les plus cordiales,
 
Matthieu 

```

The reply of Sébastien was the following

```
Cher Matthieu,

Merci encore pour ton travail. J'ai pu vérifier les données que je t'avais envoyé avec les définitives présenteent dans la table s3.
Les seules différences que j'ai pu trouver sont les suivantes : 
Pichia sporiculosa qui deveint Pichia sporocuriosa
Pichia kurdiavzevii qui deveint Pichia kurdriavzevii
Et il y avait aussi un doublon pour un isolat de Pichia sporiculosa pour la grappe G12C7.
 
Ces tables sont justes et tu peux sans autre les mettres sur le page git. Les petites imprecisions viennent des données que je t'avais transmise. Je te mets en pj les données corrigées si tu veux update les data sur la page. 

Encore merci pour ces figures aue tu as pu nous sortir, et une bonne continuation à toi aussi.

Sébastien
 
```

We slightly change the `LoadSourRot` to allow to specify the target dataset (and we have previously updloaded the file `data_sour_rot.xlsx`).

```{r LoadFunction}
LoadSourRot <- function(normalization = FALSE, data_path ="Data/data_sour_rot.xlsx" )
{
  
  # normalization: if TRUE, returns the proportion of species in each sample and not the absolute number of occurrences
  dfSourRot <- read_excel(path = data_path, col_names = T, skip = 1)
  apply(dfSourRot, 2, function(z)all(is.na(z))) |> which()
  ## rename some columns in English
  dfSourRot <- dfSourRot |>
    dplyr::rename(species = "genotype", order = "ordre")
  # We remove this problematic sample
  dfSourRot <- dfSourRot |> 
    select(-G4B1) 
  dfSourRot$family[is.na(dfSourRot$family)] <- "Incertae sedis"
  dfSourRot <- dfSourRot |> relocate(order, family, genus, species)
  
  dfSourRot <- dfSourRot |> 
    mutate(dplyr::across(.cols = -c(order, family, genus, species), .fns = ~replace_na(.,0))) 
  
  
  # removes the all 0 rows
  dfSourRot <- dfSourRot |> 
    filter(! if_all(-c(order, family, genus, species), ~. == 0))
  
  
  
  ids <- apply(dfSourRot[,1:4], 1, function(z)length(unique(z)) ) == 4
  dfSourRot <- dfSourRot[ids,]
  
  ## merge identical rows (identical means with same order, family, genus, species),
  ## by summing corresponding values of abundance
  dfSourRot <- dfSourRot |> 
    group_by(order, family, genus, species) |> 
    dplyr::summarise(across(everything(),  ~ sum(.x, na.rm = TRUE))) |> 
    ungroup()
  if(normalization)
  {
    dfSourRot <- dfSourRot |> 
      mutate(across(.cols = c(-order, -family, -genus, -species ),  ~ ./sum(.))) # use only proportion of species in samples
  }
  ## removing unwanted spaces at the beggining of a string
  dfSourRot[,1:4] <- apply(dfSourRot[,1:4], 2, function(z) stringr::str_replace(string = z, pattern = "^\\s+", replacement = ""))
  dfSourRot[,1:4] <- apply(dfSourRot[,1:4], 2, function(z) stringr::str_replace(string = z, pattern = "\\s+", replacement = " "))
  
  ## vars is the names of the samples. There are indicated as the columns of type "double"
  vars <- colnames(dfSourRot)[sapply(dfSourRot, typeof) =="double"]
  ## For each sample, we deduce from its name what is its type ("insect", "extern" or "sour rot")
  ## The patterns are provided as regular expressions
  types <- rep(NA,length(vars))
  pat <- c("male|female|other", 
           "[A-Z]\\d{2}C", # Maj-2digits-C
           "[A-Z]\\d+?B") # Maj-aussi peu de digits que possible-B
  typesNames <- c("insect", "extern", "sour rot")
  cbind(pat, typesNames)
  for(i in 1:length(pat))
  {
    ind <- grepl(pattern = pat[i], x = vars)
    types[ind] <- typesNames[i]
  }
  ## A list of three components is returned
  ## 1: the dataset itself
  ## 2: the name of the samples
  ## 3: the types corresponding to the samples
  return(list(dfSourRot = dfSourRot, vars = vars, types = types))
}
```

Then we compare the two datasets using the function `comparedf` from the package `arsenal`. 

```{r comparedf}
df_new <- LoadSourRot(data_path = "Data/data_sour_rot_sh.xlsx")
df_new <- df_new$dfSourRot

df_old <- LoadSourRot()
df_old <- df_old$dfSourRot

arsenal::comparedf(x = df_old, y = df_new) |> summary()

```

The result is in line with the statement of Sébastien. So we can update the dataset on the git page. 
